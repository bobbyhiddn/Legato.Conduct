name: Spawn Agent from Pit

on:
  repository_dispatch:
    types: [spawn-agent]

permissions:
  contents: write

jobs:
  spawn:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate payload
        run: |
          echo "Queue ID: ${{ github.event.client_payload.queue_id }}"
          echo "Project: ${{ github.event.client_payload.project_name }}"
          echo "Type: ${{ github.event.client_payload.project_type }}"

      - name: Create repository from template
        env:
          GH_TOKEN: ${{ secrets.LAB_PAT }}
          PROJECT_NAME: ${{ github.event.client_payload.project_name }}
          PROJECT_TYPE: ${{ github.event.client_payload.project_type }}
        run: |
          LEGATO_ORG=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)

          # Determine suffix based on project type
          if [ "${PROJECT_TYPE}" = "note" ]; then
            SUFFIX="Note"
          else
            SUFFIX="Chord"
          fi

          NEW_REPO="${LEGATO_ORG}/Lab.${PROJECT_NAME}.${SUFFIX}"

          echo "Creating repository: ${NEW_REPO}"

          # Create the repository
          gh repo create "${NEW_REPO}" \
            --public \
            --description "LEGATO project: ${PROJECT_NAME}"

          # Add topic tags for discoverability
          gh repo edit "${NEW_REPO}" --add-topic "legato-lab" --add-topic "legato-chord"

          # Clone the new repo
          gh repo clone "${NEW_REPO}" project-clone
          cd project-clone

          # Copy template files if they exist
          if [ -d "../templates/${PROJECT_TYPE}" ]; then
            cp -r "../templates/${PROJECT_TYPE}/." .
          fi

          # Initial commit
          git add .
          git commit -m "Initialize ${PROJECT_NAME} from LEGATO template" || true
          git push || true

      - name: Write SIGNAL.md
        env:
          GH_TOKEN: ${{ secrets.LAB_PAT }}
          SIGNAL_JSON: ${{ toJson(github.event.client_payload.signal_json) }}
          PROJECT_NAME: ${{ github.event.client_payload.project_name }}
          PROJECT_TYPE: ${{ github.event.client_payload.project_type }}
        run: |
          LEGATO_ORG=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)

          if [ "${PROJECT_TYPE}" = "note" ]; then
            SUFFIX="Note"
          else
            SUFFIX="Chord"
          fi

          cd project-clone

          # Parse signal JSON and write SIGNAL.md
          cat > SIGNAL.md << 'SIGNAL_EOF'
          # Project Signal

          This project was spawned by LEGATO via Pit approval.

          ## Metadata
          - Queue ID: ${{ github.event.client_payload.queue_id }}
          - Project: ${{ github.event.client_payload.project_name }}
          - Type: ${{ github.event.client_payload.project_type }}
          SIGNAL_EOF

          git add SIGNAL.md
          git commit -m "Add project signal metadata" || true
          git push || true

      - name: Create issue and assign to Copilot
        env:
          GH_TOKEN: ${{ secrets.LAB_PAT }}
          TASKER_BODY: ${{ github.event.client_payload.tasker_body }}
          PROJECT_NAME: ${{ github.event.client_payload.project_name }}
          PROJECT_TYPE: ${{ github.event.client_payload.project_type }}
        run: |
          LEGATO_ORG=$(echo "${GITHUB_REPOSITORY}" | cut -d'/' -f1)

          if [ "${PROJECT_TYPE}" = "note" ]; then
            SUFFIX="Note"
          else
            SUFFIX="Chord"
          fi

          REPO="${LEGATO_ORG}/Lab.${PROJECT_NAME}.${SUFFIX}"
          REPO_NAME="Lab.${PROJECT_NAME}.${SUFFIX}"

          echo "Creating issue in ${REPO} using REST API..."

          # Create issue using REST API (auto-creates labels)
          ISSUE_RESPONSE=$(gh api "/repos/${REPO}/issues" \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -f title="Initial Implementation" \
            -f body="${TASKER_BODY}" \
            -f "labels[]=copilot")

          ISSUE_NUMBER=$(echo "${ISSUE_RESPONSE}" | jq -r '.number')
          ISSUE_URL=$(echo "${ISSUE_RESPONSE}" | jq -r '.html_url')

          echo "Issue created: #${ISSUE_NUMBER} - ${ISSUE_URL}"

          # Wait for GitHub to fully process the issue
          sleep 2

          # Get issue node ID for GraphQL
          echo "Getting issue GraphQL ID..."
          ISSUE_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!, $number: Int!) {
              repository(owner: $owner, name: $repo) {
                issue(number: $number) {
                  id
                }
              }
            }
          ' -f owner="${LEGATO_ORG}" -f repo="${REPO_NAME}" -F number="${ISSUE_NUMBER}" --jq '.data.repository.issue.id')

          if [ -z "${ISSUE_ID}" ] || [ "${ISSUE_ID}" = "null" ]; then
            echo "ERROR: Could not get issue GraphQL ID"
            exit 1
          fi

          echo "Issue GraphQL ID: ${ISSUE_ID}"

          # Get Copilot actor ID from repository suggestedActors
          echo "Finding Copilot in suggested actors..."
          COPILOT_ID=$(gh api graphql -f query='
            query($owner: String!, $repo: String!) {
              repository(owner: $owner, name: $repo) {
                suggestedActors(capabilities: [CAN_BE_ASSIGNED], first: 100) {
                  nodes {
                    login
                    ... on Bot { id }
                    ... on User { id }
                  }
                }
              }
            }
          ' -f owner="${LEGATO_ORG}" -f repo="${REPO_NAME}" --jq '.data.repository.suggestedActors.nodes[] | select(.login == "copilot-swe-agent") | .id')

          if [ -z "${COPILOT_ID}" ] || [ "${COPILOT_ID}" = "null" ]; then
            echo "ERROR: Copilot (copilot-swe-agent) not available as assignee"
            echo "Make sure Copilot coding agent is enabled for this repo/org"
            exit 1
          fi

          echo "Copilot ID: ${COPILOT_ID}"

          # Assign to Copilot using GraphQL with proper JSON
          echo "Assigning issue to Copilot..."
          ASSIGN_RESULT=$(gh api graphql \
            --raw-field query='
              mutation AssignToCopilot($issueId: ID!, $actorIds: [ID!]!) {
                replaceActorsForAssignable(input: {
                  assignableId: $issueId,
                  actorIds: $actorIds
                }) {
                  assignable {
                    ... on Issue {
                      assignees(first: 5) {
                        nodes {
                          login
                        }
                      }
                    }
                  }
                }
              }
            ' \
            --raw-field variables="$(jq -n --arg issueId "${ISSUE_ID}" --arg copilotId "${COPILOT_ID}" '{issueId: $issueId, actorIds: [$copilotId]}')")

          # Verify assignment
          ASSIGNEES=$(echo "${ASSIGN_RESULT}" | jq -r '.data.replaceActorsForAssignable.assignable.assignees.nodes[].login' 2>/dev/null || echo "")

          if echo "${ASSIGNEES}" | grep -q "copilot"; then
            echo "SUCCESS: Issue assigned to Copilot"
            echo "Assignees: ${ASSIGNEES}"
          else
            echo "WARNING: Assignment may have failed"
            echo "Response: ${ASSIGN_RESULT}"
          fi
